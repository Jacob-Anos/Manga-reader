<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manga / Manhwa Tracker ‚Äì PWA (simple)</title>
  <meta name="theme-color" content="#151835" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MangaTracker">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" href="icon-192.png">
  <style>
    :root{ --bg:#0f1220; --card:#151835; --muted:#8ea3c2; --text:#e8eeff; --accent:#6ea8ff; --danger:#ff7a7a; --radius:16px; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 120px}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(15,18,32,.98),rgba(15,18,32,.85),rgba(15,18,32,0));backdrop-filter:blur(6px);z-index:10;padding:10px 0 8px;margin-bottom:10px}
    h1{font-size:22px;margin:0 0 6px;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,button,select{border:none;outline:none}
    input{background:#0f1430;color:var(--text);padding:10px 12px;border-radius:12px;min-width:0}
    input[type="url"], input[type="text"], .grow{flex:1 1 220px}
    button{background:#1b2350;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2a5fff,#2563eb)}
    button.ghost{background:#0e1230}
    button.warn{background:#5b1a1a}
    button.small{padding:6px 10px;border-radius:9px;font-size:13px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px 12px;margin:10px 0;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .item{display:flex;flex-direction:column;gap:10px}
    .item-head{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .title{font-weight:600;font-size:16px;line-height:1.2}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .note{font-size:12px;color:var(--muted)}
    .sep{height:1px;background:#27305f;opacity:.6;margin:6px 0}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{background:#0c1130;border:1px solid #27306b;border-radius:999px;padding:6px 10px;font-size:13px;color:var(--muted)}
    .link{color:var(--accent);text-decoration:none}
    .footer{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(0deg,rgba(21,24,53,.98),rgba(21,24,53,.85),rgba(21,24,53,0));backdrop-filter:blur(6px);padding:12px 14px}
    .footer .row{align-items:center}
    .kbd{font-family:ui-monospace,Menlo,monospace;font-size:12px;background:#0b0f27;border:1px solid #2b356e;border-bottom-width:2px;border-radius:6px;padding:2px 6px}
    .sr{position:absolute;left:-9999px}
    .install{display:none;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üìö Manga / Manhwa Tracker <span class="muted">(simple PWA)</span></h1>
      <div class="muted">Pamatuje si <b>posledn√≠ otev≈ôenou URL</b> pro ka≈ædou s√©rii. Data jsou jen u tebe v <b>localStorage</b>.</div>
      <div class="row install" id="installRow">
        <button id="btnInstall" class="primary small">‚ûï Nainstalovat aplikaci</button>
        <span class="muted">v Safari: Sd√≠let ‚Üí <b>P≈ôidat na plochu</b></span>
      </div>
    </header>

    <!-- P≈ôid√°n√≠ s√©rie: pouze N√°zev + Startovn√≠ URL -->
    <section class="card" aria-labelledby="addform">
      <h2 id="addform" class="sr">P≈ôidat s√©rii</h2>
      <div class="row">
        <input id="title" class="grow" placeholder="N√°zev s√©rie (nap≈ô. Omniscient Reader)" />
        <input id="startUrl" class="grow" placeholder="URL kapitoly (co teƒè ƒçte≈°)" />
        <button class="primary" onclick="addSeries()">+ P≈ôidat</button>
        <button class="ghost" onclick="exportData()">Export</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importData(this)" />
        <button class="ghost" onclick="document.getElementById('importFile').click()">Import</button>
      </div>
      <div class="note">Tip: Pou≈æ√≠vej <b>bookmarklet</b> u ka≈æd√© s√©rie pro <u>okam≈æit√© ulo≈æen√≠</u> pr√°vƒõ otev≈ôen√© kapitoly z webu ƒçteƒçky.</div>
    </section>

    <!-- Filtr + poƒçet -->
    <section class="card toolbar">
      <input id="search" class="grow" placeholder="Hledat v n√°zvech‚Ä¶" oninput="render()" />
      <span class="pill" id="count">0 polo≈æek</span>
    </section>

    <!-- Seznam s√©ri√≠ -->
    <section id="list" class="grid" aria-live="polite"></section>

    <div class="footer">
      <div class="row">
        <div class="muted">iPhone: otev≈ôi str√°nku s√©rie, klepni na jej√≠ <b>bookmarklet</b> ‚Üí ulo≈æ√≠ se ‚Äûposledn√≠ URL‚Äú. Pak v appce klikni <b>Pokraƒçovat</b>.</div>
      </div>
    </div>
  </div>

<script>
/* ====== Mini store (pouze title + lastUrl) ====== */
const KEY = 'manga_simple_v1';
let items = [];

function save(){ localStorage.setItem(KEY, JSON.stringify(items)); }
function load(){ try{ items = JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ items=[] } }
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }

/* ====== P≈ôid√°n√≠, √∫pravy, maz√°n√≠ ====== */
function addSeries(){
  const title = document.getElementById('title').value.trim();
  const startUrl = document.getElementById('startUrl').value.trim();
  if(!title) return alert('Zadej n√°zev s√©rie');
  if(!startUrl) return alert('Vlo≈æ startovn√≠ URL (kapitolu, kterou ƒçte≈°).');
  items.unshift({ id:uid(), title, lastUrl:startUrl, updated:Date.now() });
  save();
  document.getElementById('title').value = '';
  document.getElementById('startUrl').value = '';
  render();
}

function removeItem(id){
  if(!confirm('Odebrat tuto s√©rii?')) return;
  items = items.filter(x=>x.id!==id);
  save(); render();
}

function setLastUrl(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  const v = prompt('Vlo≈æ/zmƒõ≈à posledn√≠ URL:', it.lastUrl||'');
  if(v===null) return;
  it.lastUrl = (v.trim()||undefined);
  it.updated = Date.now();
  save(); render();
}

/* ====== Bookmarklet (per-s√©rie) ======
   Funguje tak, ≈æe z kter√©koliv str√°nky kapitoly klikne≈° na ulo≈æen√Ω bookmarklet s√©rie
   ‚Üí p≈ôesmƒõruje tƒõ do t√©to PWA s parametry ?save=<url>&id=<id>, PWA ulo≈æ√≠ a potvrd√≠. */
function bookmarkletHref(seriesId){
  const app = new URL('./', location.href).toString(); // root t√©to appky
  const code = `
    (function(){
      var u=location.href;
      location.href='${app}?save='+encodeURIComponent(u)+'&id=${seriesId}';
    })();
  `.replace(/\s+/g,' ');
  return 'javascript:' + encodeURIComponent(code);
}

/* ====== Akce: Pokraƒçovat ====== */
function openCurrent(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  if(!it.lastUrl) return alert('Nem√°m URL ‚Äì dopl≈à Posledn√≠ URL.');
  // Otev≈ôu posledn√≠ zn√°mou; POZOR: bez ≈°ablon neum√≠me automaticky rozpoznat ‚Äûdal≈°√≠‚Äú str√°nku,
  // proto pou≈æij bookmarklet, kdy≈æ v readeru p≈ôejde≈° na jinou kapitolu ‚Üí a≈• si appka URL zapamatuje.
  window.open(it.lastUrl, '_blank');
}

/* ====== Render seznamu ====== */
function render(){
  const q = document.getElementById('search').value.trim().toLowerCase();
  const list = document.getElementById('list');
  const filtered = items
    .filter(it => !q || it.title.toLowerCase().includes(q))
    .sort((a,b)=> b.updated - a.updated);

  document.getElementById('count').textContent = filtered.length + (filtered.length===1?' polo≈æka':' polo≈æek');

  list.innerHTML = '';
  if(filtered.length===0){
    const empty = document.createElement('div');
    empty.className = 'card';
    empty.innerHTML = '<div class="muted">Nic tu nen√≠. Zadej n√°zev a URL v√Ω≈°e. üëÜ</div>';
    list.appendChild(empty);
    return;
  }

  filtered.forEach(it=>{
    const card = document.createElement('div'); card.className='card item';

    const head = document.createElement('div'); head.className='item-head';
    const t = document.createElement('div'); t.className='title'; t.textContent = it.title; head.appendChild(t);

    const actions = document.createElement('div'); actions.className='actions';
    const btnOpen = document.createElement('button'); btnOpen.textContent='Pokraƒçovat'; btnOpen.className='primary small'; btnOpen.onclick=()=>openCurrent(it.id); actions.appendChild(btnOpen);
    const btnSet = document.createElement('button'); btnSet.textContent='Zmƒõnit URL'; btnSet.className='ghost small'; btnSet.onclick=()=>setLastUrl(it.id); actions.appendChild(btnSet);
    const btnDel = document.createElement('button'); btnDel.textContent='Smazat'; btnDel.className='warn small'; btnDel.onclick=()=>removeItem(it.id); actions.appendChild(btnDel);
    head.appendChild(actions);

    const note = document.createElement('div'); note.className='note';
    note.innerHTML = 'Posledn√≠: ' + (it.lastUrl ? `<a class="link" href="${it.lastUrl}" target="_blank">${it.lastUrl}</a>` : '<i>nenastaveno</i>');

    const bm = document.createElement('div'); bm.className='note';
    const a = document.createElement('a'); a.className='link'; a.textContent='üìé Bookmarklet: Ulo≈æit tuto str√°nku pro "'+it.title+'"';
    a.href = bookmarkletHref(it.id);
    a.title = 'P≈ôet√°hni do li≈°ty z√°lo≈æek / ulo≈æ jako z√°lo≈æku. Na str√°nce kapitoly na nƒõj klikni ‚Äî ulo≈æ√≠ se jako Posledn√≠ URL.';
    bm.appendChild(a);

    card.appendChild(head);
    card.appendChild(document.createElement('div')).className='sep';
    card.appendChild(note);
    card.appendChild(bm);
    list.appendChild(card);
  });
}

/* ====== Import/Export ====== */
function exportData(){
  const data = JSON.stringify(items, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'manga-tracker.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importData(input){
  const file = input.files?.[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const arr = JSON.parse(reader.result);
      if(!Array.isArray(arr)) throw new Error('Neplatn√Ω JSON');
      // slouƒçen√≠ podle n√°zvu + URL
      const key = o=> (o.title||'')+'|'+(o.lastUrl||'');
      const map = new Map(items.map(x=>[key(x),x]));
      for(const o of arr){
        const k = key(o);
        if(map.has(k)){
          const ex = map.get(k);
          ex.lastUrl = o.lastUrl || ex.lastUrl;
          ex.updated = Math.max(Number(ex.updated||0), Number(o.updated||0));
        }else{
          map.set(k, {id:uid(), title:o.title||'Bez n√°zvu', lastUrl:o.lastUrl||undefined, updated:Number(o.updated||Date.now())});
        }
      }
      items = Array.from(map.values());
      save(); render(); input.value='';
      alert('Import hotov√Ω.');
    }catch(e){ alert('Import selhal: '+e.message) }
  };
  reader.readAsText(file);
}

/* ====== P≈ô√≠jem bookmarkletu: ?save=<url>&id=<id> ====== */
(function handleSaveParam(){
  const p = new URL(location.href).searchParams;
  const saveUrl = p.get('save');
  const id = p.get('id');
  if(saveUrl && id){
    const it = items.find(x=>x.id===id);
    if(it){
      it.lastUrl = saveUrl;
      it.updated = Date.now();
      save();
      // ƒçistƒõ UX: uka≈æ potvrzen√≠
      setTimeout(()=>alert('Ulo≈æeno jako posledn√≠ URL pro: '+it.title), 50);
      // Odstranit parametry z adresy (aby se znovu neulo≈æily p≈ôi reloadu)
      history.replaceState({}, '', location.pathname);
    }
  }
})();

/* ====== PWA: SW + instalace ====== */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./service-worker.js').catch(console.error) });
}
let deferredPrompt; const installRow = document.getElementById('installRow'); const btnInstall = document.getElementById('btnInstall');
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; if(installRow) installRow.style.display='flex'; });
btnInstall?.addEventListener('click', async ()=>{
  if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; if(installRow) installRow.style.display='none';
});

/* ====== Start ====== */
load(); render();
</script>
</body>
</html>
