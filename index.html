<script>
const KEY = 'manga_tracker_v1';
let items = [];

function save(){ localStorage.setItem(KEY, JSON.stringify(items)); }
function load(){ try{ items = JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ items=[] } }
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }
function fmtCount(n){ return n+ (n===1?' polo≈æka':' polo≈æek') }

// ‚¨áÔ∏è odhad kapitoly z Posledn√≠ URL (vezme posledn√≠ ƒç√≠slo v URL)
function parseChapterFromUrl(u){
  if(!u) return 0;
  const m = String(u).match(/(\d+)(?!.*\d)/);
  return m ? Number(m[1]) : 0;
}

// ‚¨áÔ∏è URL gener√°tory
function currentUrl(it){
  return it.lastUrl || (it.template ? it.template.replace('{n}', String(it.chapter||0)) : '');
}
function nextUrl(it){
  if(!it.template) return '';
  const n = (typeof it.chapter==='number'? it.chapter+1 : 1);
  return it.template.replace('{n}', String(n));
}

// ‚¨áÔ∏è P≈ôid√°n√≠ s√©rie ‚Äì pokud nevypln√≠≈° kapitolu, zkus√≠ se z Posledn√≠ URL
function addSeries(){
  const title = document.getElementById('title').value.trim();
  const template = document.getElementById('template').value.trim();
  const lastUrl = document.getElementById('lastUrl').value.trim();
  let chapter = Number(document.getElementById('chapter').value);
  const status = document.getElementById('status').value;

  if(!title) return alert('Zadej n√°zev s√©rie');
  if(!template && !lastUrl) return alert('Vypl≈à buƒè URL ≈°ablonu nebo posledn√≠ URL.');

  if((!Number.isFinite(chapter) || chapter<0) && lastUrl){
    chapter = parseChapterFromUrl(lastUrl) || 0;
  }
  if(!Number.isFinite(chapter) || chapter<0) chapter = 0;

  items.unshift({
    id:uid(), title,
    template: template || undefined,
    lastUrl: lastUrl || undefined,
    chapter, status,
    updated: Date.now()
  });
  save();
  clearForm(); // po p≈ôid√°n√≠ vyƒçistit formul√°≈ô
  render();
}

function clearForm(){
  ['title','template','lastUrl','chapter'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('status').value='reading';
}

function updateItem(id, patch){
  const i = items.findIndex(x=>x.id===id); if(i<0) return;
  items[i] = {...items[i], ...patch, updated:Date.now()};
  save(); render();
}

function removeItem(id){
  if(!confirm('Odebrat tuto s√©rii?')) return;
  items = items.filter(x=>x.id!==id); save(); render();
}

// ‚¨áÔ∏è Otev≈ô√≠t aktu√°ln√≠ ‚Äì synchronizuje lastUrl podle ≈°ablony + kapitoly
function openCurrent(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  if(it.template){ it.lastUrl = currentUrl(it); save(); } // sync reality
  const url = currentUrl(it);
  if(!url){ return alert('Nem√°m URL ‚Äì dopl≈à ≈°ablonu nebo posledn√≠ URL.'); }
  window.open(url,'_blank');
}

// ‚¨áÔ∏è Dal≈°√≠ kapitola ‚Äì nav√Ω≈°√≠ kapitolu, uprav√≠ lastUrl a otev≈ôe
function nextChapter(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  if(!it.template) return alert('Pro skok na dal≈°√≠ kapitolu nastav URL ≈°ablonu s {n}.');
  if(typeof it.chapter !== 'number') it.chapter = 0;
  it.chapter += 1;
  it.status = 'reading';
  it.lastUrl = currentUrl(it) || nextUrl(it); // sync reality
  it.updated = Date.now();
  save(); render();
  const url = currentUrl(it) || nextUrl(it);
  if(url) window.open(url,'_blank');
}

// ‚¨áÔ∏è Ruƒçn√≠ nastaven√≠ kapitoly ‚Äì pokud existuje ≈°ablona, p≈ôegeneruje lastUrl
function setChapter(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  const v = prompt('Nastav kapitolu na:', it.chapter||0);
  if(v===null) return;
  const n = Number(v);
  if(Number.isNaN(n)) return alert('ƒå√≠slo kapitoly mus√≠ b√Ωt ƒç√≠slo');
  it.chapter = n;
  if(it.template){ it.lastUrl = currentUrl(it); }
  updateItem(id,{});
}

// ‚¨áÔ∏è Ruƒçn√≠ nastaven√≠ Posledn√≠ URL ‚Äì p≈ôepoƒç√≠t√° i kapitolu
function setLastUrl(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  const v = prompt('Vlo≈æ/zmƒõ≈à posledn√≠ URL:', it.lastUrl||'');
  if(v===null) return;
  const cleaned = v.trim();
  it.lastUrl = cleaned || undefined;
  const guessed = parseChapterFromUrl(cleaned);
  if(Number.isFinite(guessed) && guessed>=0){ it.chapter = guessed; }
  updateItem(id,{});
}

function setTemplate(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  const v = prompt('URL ≈°ablona s {n}:', it.template||'');
  if(v===null) return;
  it.template = v.trim() || undefined;
  // pokud m√°me kapitolu, rovnou srovnej lastUrl podle ≈°ablony
  if(it.template){ it.lastUrl = currentUrl(it); }
  updateItem(id,{});
}

function toggleFinished(id){
  const it = items.find(x=>x.id===id); if(!it) return;
  updateItem(id,{status: it.status==='finished' ? 'reading' : 'finished'});
}

function render(){
  const qEl = document.getElementById('search');
  const fEl = document.getElementById('filter');
  const q = qEl? qEl.value.trim().toLowerCase() : '';
  const f = fEl? fEl.value : 'all';
  const list = document.getElementById('list');
  const filtered = items
    .filter(it=> (f==='all'||it.status===f) && (!q || it.title.toLowerCase().includes(q)) )
    .sort((a,b)=> b.updated - a.updated);

  const countEl = document.getElementById('count');
  if(countEl) countEl.textContent = fmtCount(filtered.length);

  list.innerHTML = '';
  if(filtered.length===0){
    const empty = document.createElement('div');
    empty.className='card';
    empty.innerHTML = '<div class="muted">Nic tu nen√≠. P≈ôidej prvn√≠ s√©rii v√Ω≈°e. üëÜ</div>';
    list.appendChild(empty);
    return;
  }

  filtered.forEach(it=>{
    const card = document.createElement('div'); card.className='card item';

    const head = document.createElement('div'); head.className='item-head';
    const t = document.createElement('div'); t.className='title'; t.textContent = it.title; head.appendChild(t);

    const badges = document.createElement('div'); badges.className='badges';
    const b1 = document.createElement('span'); b1.className='badge';
    b1.textContent = 'Kapitola: '+(Number.isFinite(it.chapter)? it.chapter : '-'); badges.appendChild(b1);
    const b2 = document.createElement('span'); b2.className='badge';
    b2.textContent = it.status==='finished'?'Doƒçteno': it.status==='paused'?'Pozastaveno':'ƒåtu'; badges.appendChild(b2);
    if(it.template){ const b3=document.createElement('span'); b3.className='badge'; b3.textContent='≈†ablona ‚úì'; badges.appendChild(b3); }
    if(it.lastUrl){ const b4=document.createElement('span'); b4.className='badge'; b4.textContent='Posledn√≠ URL ‚úì'; badges.appendChild(b4); }
    head.appendChild(badges);

    const actions = document.createElement('div'); actions.className='actions';
    const btnOpen = document.createElement('button'); btnOpen.textContent='Pokraƒçovat'; btnOpen.className='primary small'; btnOpen.onclick=()=>openCurrent(it.id); actions.appendChild(btnOpen);

    // +1 jen kdy≈æ existuje ≈°ablona
    if(it.template){
      const btnNext = document.createElement('button'); btnNext.textContent='+1 kapitola & otev≈ô√≠t'; btnNext.className='small'; btnNext.onclick=()=>nextChapter(it.id); actions.appendChild(btnNext);
    }

    const btnSetCh = document.createElement('button'); btnSetCh.textContent='Nastavit kapitolu'; btnSetCh.className='ghost small'; btnSetCh.onclick=()=>setChapter(it.id); actions.appendChild(btnSetCh);
    const btnSetTpl = document.createElement('button'); btnSetTpl.textContent='URL ≈°ablona'; btnSetTpl.className='ghost small'; btnSetTpl.onclick=()=>setTemplate(it.id); actions.appendChild(btnSetTpl);
    const btnSetUrl = document.createElement('button'); btnSetUrl.textContent='Posledn√≠ URL'; btnSetUrl.className='ghost small'; btnSetUrl.onclick=()=>setLastUrl(it.id); actions.appendChild(btnSetUrl);
    const btnDone = document.createElement('button'); btnDone.textContent= (it.status==='finished'?'Vr√°tit do ƒçten√≠':'Oznaƒçit doƒçteno'); btnDone.className='success small'; btnDone.onclick=()=>toggleFinished(it.id); actions.appendChild(btnDone);
    const btnDel = document.createElement('button'); btnDel.textContent='Odebrat'; btnDel.className='warn small'; btnDel.onclick=()=>removeItem(it.id); actions.appendChild(btnDel);

    const note = document.createElement('div'); note.className='note';
    const cur = currentUrl(it), nxt = nextUrl(it);
    note.innerHTML =
      'Aktu√°ln√≠: ' + (cur ? `<a class="link" href="${cur}" target="_blank">${cur}</a>` : '<i>nenastaveno</i>') +
      (it.template ? (' &nbsp;|&nbsp; Dal≈°√≠: ' + (nxt ? `<a class="link" href="${nxt}" target="_blank">${nxt}</a>` : '<i>≈°ablona bez {n}</i>')) : '');
    card.appendChild(head); card.appendChild(actions); card.appendChild(document.createElement('div')).className='sep'; card.appendChild(note);

    list.appendChild(card);
  });
}

// === PWA: registrace SW + instalace ===
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./service-worker.js').catch(console.error) })
}
let deferredPrompt; const installRow = document.getElementById('installRow'); const btnInstall = document.getElementById('btnInstall');
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; if(installRow) installRow.style.display='flex'; });
btnInstall?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; if(installRow) installRow.style.display='none'; });

// Init
load(); render();
</script>
